<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/basic::setContent(~{this::content})}">
    <th:block th:fragment="content"> <!--/* 함수 호출 시 파라미터 전달 영역 */-->
        <h1 class="mt-4">Board Read Page</h1>
        <div class="form-group">
            <label>Bno</label>
            <input type="text" name="bno" class="form-control" th:value="${dto.bno}" readonly>
        </div>
        <div class="form-group">
            <label>제목</label>
            <input type="text" name="title" class="form-control" th:value="${dto.title}" readonly>
        </div>
        <div class="form-group">
            <label>내용</label>
            <textarea type="text" name="content" class="form-control" rows="5" readonly>[[${dto.content}]]</textarea>
        </div>
        <div class="form-group">
            <label>작성자</label>
            <input type="text" name="writerName" class="form-control" th:value="${dto.writerName}" readonly>
        </div>
        <div class="form-group">
            <label>등록일</label>
            <input type="text" name="regDate" class="form-control" th:value="${#temporals.format(dto.regDate, 'yyyy/MM/dd HH:mm:ss')}" readonly>
        </div>
        <div class="form-group">
            <label>수정일</label>
            <input type="text" name="modDate" class="form-control" th:value="${#temporals.format(dto.modDate, 'yyyy/MM/dd HH:mm:ss')}" readonly>
        </div>
        <a th:href="@{/board/modify(bno=${dto.bno},page=${requestDTO.page},type=${requestDTO.type},keyword=${requestDTO.keyword})}">
            <button class="btn btn-primary">수정</button>
        </a>
        <a th:href="@{/board/list(page=${requestDTO.page},type=${requestDTO.type},keyword=${requestDTO.keyword})}">
            <button class="btn btn-info">목록</button>
        </a>
        <div class="mt-4">
            <h5><span class="badge badge-info addReply">댓글등록</span></h5>
                <h5><span class="badge badge-secondary replyCount">댓글 갯수[[${dto.replyCount}]]</span> </h5>
        </div>
            <div class="list-group replyList">
            </div>
                <div class="modal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Modal title</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">

                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <input type="text" class="form-control" name="replyText" placeholder="댓글 테스트...">
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-control" name="replyer" placeholder="댓글 작성자...">
                                    <input th:type="hidden" name="rno">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger replyRemove">삭제</button>
                                <button type="button" class="btn btn-warning replySave">저장</button>
                                <button type="button" class="btn btn-outline-secondary replyClose">닫기</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script th:inline="javascript">

            $(document).ready(function (){
                var bno = [[${dto.bno}]]
                //댓글이 추가될 영역
                var listGroup = $(".replyList")

                //날짜 처리를 위한 함수
                function formatTime(str){
                    var date = new Date();
                    return date.getFullYear() + '/' + (date.getMonth()+1) +'/' +date.getDate() + ' ' * date.getHours()* ':' + date.getMinutes();
                }
                //특정한 게시글의 댓글을 처리하는 함수
                function loadJSONData(){
                    $.getJSON('/replies/board/' +bno, function (arr){
                        console.log(arr);
                        var str="";
                        $('.replyCount').html( " 댓글 갯수 " + arr.length)
                        $.each(arr, function (idx, reply){
                            console.log(reply)
                            str += ' <div class="card-body" data-rno="' + reply.rno+ '"><b>' * reply.rno + '</b>'
                            str += '  <h5 class="card-title">' + reply.text +'</h5>'
                            str += ' <h6 class="card-subtitle mb-2 text-muted">' +reply.replyer+ '</h6>'
                            str += ' <p class="card-text">' +formatTime(reply.regDate) + '</p>'
                            str += '  </div>'
                        })
                        console.log(str);
                        listGroup.html(str);
                    })
                }

                $(".replyCount").click(function (){
                    loadJSONData();
                })
                var modal = $(".modal")
                $(".addReply").click(function (e){
                    modal.modal('show');
                    //댓글 입력하는 부분 초기화
                    $('.input[name="replyText"]').val('')
                    $('.input[name="replyer"]').val('')
                    $(".modal-footer .btn").hide() //모달 내의 모든 버튼 안보이도록
                    $(".replySave , .replyClose").show() //필요한 버튼들만 보이도록
                })
                $(".replySave").click(function (){
                    var reply ={
                        bno,
                        text:$('input[name="replyText"]').val(),
                        replyer:$('input[name="replyer"]').val()
                    }
                    $.ajax({
                        url:'/replies/',
                        method:'post',
                        data:JSON.stringify(reply),
                        contentType:'application/json; charset=utf-8',
                        dataType:'json',
                        success:function (data){
                            console.log(data)
                            var newRno = parseInt(data)
                            alert(newRno + " 빈 댓글이 등록되었습니다.")
                            modal.modal('hide')
                            loadJSONData();
                        }
                    })
                })
            })
        </script>
    </th:block>
</th:block>